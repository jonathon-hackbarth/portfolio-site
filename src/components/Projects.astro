---
import type { ProjectData } from "../utils/projectUtils";
import { getProjectsData } from "../utils/projectUtils";
import ProjectCard from "./ProjectCard.astro";

const GITHUB_USERNAME = "jonathon-hackbarth";

let projects: ProjectData[] = [];
let error: string | null = null;
try {
  const token = import.meta.env.GH_TOKEN;
  if (!token) throw new Error("GitHub token not configured");

  // Fetch repos directly from GitHub (avoids internal /api call in SSR context)
  const repoRes = await fetch(
    `https://api.github.com/users/${GITHUB_USERNAME}/repos?sort=updated&direction=desc`,
    {
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: "application/vnd.github.v3+json",
      },
    }
  );
  if (!repoRes.ok) {
    throw new Error(`GitHub API responded with ${repoRes.status}`);
  }
  const repos = await repoRes.json();
  projects = await getProjectsData(repos, token);
} catch (err) {
  error = err instanceof Error ? err.message : "Failed to load projects";
}
---

<section id="projects" class="projects-section">
  <h2 class="projects-title">Recent Projects</h2>
  {
    error && (
      <div class="flex justify-center items-center py-8">
        <div class="text-center text-red-500">Error: {error}</div>
      </div>
    )
  }
  {
    !error && projects.length === 0 && (
      <div class="flex justify-center items-center py-8">
        <div class="text-center">No projects found.</div>
      </div>
    )
  }
  {
    !error && projects.length > 0 && (
      <div class="projects-grid flex flex-wrap gap-4">
        {projects.map((p) => (
          <ProjectCard project={p} />
        ))}
      </div>
    )
  }
  <script src="../scripts/clipboard.js"></script>
  <div
    id="clone-status-live"
    class="sr-only"
    aria-live="polite"
    aria-atomic="true"
  >
  </div>
</section>
