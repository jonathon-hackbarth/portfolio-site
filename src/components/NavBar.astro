---
import { Image } from 'astro:assets';

const navItems = [
  { href: "#hero", label: "Home" },
  { href: "#impact", label: "Impact" },
  { href: "#resume", label: "Resume" },
  { href: "#code-samples", label: "Code" },
];
---

<a
  href="#main-content"
  class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[110] focus:bg-[var(--bg-elevated)] focus:text-[var(--accent)] focus:px-3 focus:py-2 focus:rounded-lg focus:border focus:border-[var(--accent)]"
>
  Skip to content
</a>

<nav class="navbar" aria-label="Primary">
  <div class="navbar-inner">
    <!-- Profile Picture (left) -->
    <div class="nav-profile">
      <img src="/me-image.webp" alt="Jonathon Hackbarth" class="nav-profile-img" id="profile-img" />
    </div>

    <!-- Desktop Navigation (center) - hidden on mobile -->
    <ul class="nav-desktop" role="list">
      {navItems.map((item) => (
        <li>
          <a href={item.href} class="nav-link">
            {item.label}
          </a>
        </li>
      ))}
    </ul>

    <!-- Actions (right) -->
    <div class="nav-actions">
      <!-- Mobile Menu Button - only on mobile -->
      <button
        id="mobile-menu-toggle"
        class="nav-mobile-toggle"
        type="button"
        aria-label="Toggle navigation menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="4" y1="6" x2="20" y2="6"/>
          <line x1="4" y1="12" x2="20" y2="12"/>
          <line x1="4" y1="18" x2="20" y2="18"/>
        </svg>
        <svg class="close-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      
      <!-- Theme Toggle - always visible -->
      <button
        id="theme-toggle"
        class="theme-toggle"
        type="button"
        aria-label="Toggle theme"
        title="Toggle theme"
      >
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg class="moon-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu Dropdown -->
  <div class="mobile-menu" id="mobile-menu" role="menu">
    <ul role="list">
      {navItems.map((item) => (
        <li>
          <a href={item.href} class="nav-link" role="menuitem">
            {item.label}
          </a>
        </li>
      ))}
    </ul>
  </div>
</nav>

<script>
  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = mobileMenuToggle?.querySelector('.menu-icon');
  const closeIcon = mobileMenuToggle?.querySelector('.close-icon');

  mobileMenuToggle?.addEventListener('click', () => {
    const isOpen = mobileMenu?.classList.contains('open');
    
    if (isOpen) {
      mobileMenu?.classList.remove('open');
      mobileMenuToggle.setAttribute('aria-expanded', 'false');
      menuIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
    } else {
      mobileMenu?.classList.add('open');
      mobileMenuToggle.setAttribute('aria-expanded', 'true');
      menuIcon?.classList.add('hidden');
      closeIcon?.classList.remove('hidden');
    }
  });

  // Close mobile menu when clicking a link
  mobileMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      mobileMenu.classList.remove('open');
      mobileMenuToggle?.setAttribute('aria-expanded', 'false');
      menuIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
    });
  });

  // Active nav link on scroll and profile image border color
  const sections = document.querySelectorAll('section[id]');
  const navLinks = document.querySelectorAll('.nav-link');
  const profileImg = document.getElementById('profile-img');

  // Map section IDs to their accent colors
  const sectionAccentColors = {
    'hero': 'var(--accent-hero)',       // Teal
    'impact': 'var(--accent-impact)',   // Orange
    'resume': 'var(--accent)',          // Blue
    'code-samples': 'var(--accent-code)' // Coral
  };

  function setActiveLink() {
    const scrollY = window.scrollY;
    let currentSectionId = 'hero'; // Default to hero
    
    sections.forEach(section => {
      const sectionTop = (section as HTMLElement).offsetTop - 100;
      const sectionHeight = (section as HTMLElement).offsetHeight;
      const sectionId = section.getAttribute('id');
      
      if (scrollY >= sectionTop && scrollY < sectionTop + sectionHeight) {
        currentSectionId = sectionId || 'hero';
        navLinks.forEach(link => {
          link.classList.remove('is-active');
          if (link.getAttribute('href') === `#${sectionId}`) {
            link.classList.add('is-active');
          }
        });
      }
    });

    // Update profile image border color based on current section
    if (profileImg) {
      const accentColor = sectionAccentColors[currentSectionId as keyof typeof sectionAccentColors];
      if (accentColor) {
        // Get the CSS variable value
        const computedColor = getComputedStyle(document.documentElement).getPropertyValue(accentColor.replace('var(', '').replace(')', '')).trim();
        profileImg.style.borderColor = computedColor || accentColor;
      }
    }
  }

  window.addEventListener('scroll', setActiveLink);
  setActiveLink();

  // Theme toggle with View Transitions API
  const themeToggle = document.getElementById('theme-toggle');
  const html = document.documentElement;
  const sunIcon = themeToggle?.querySelector('.sun-icon');
  const moonIcon = themeToggle?.querySelector('.moon-icon');

  // Initialize theme from localStorage or system preference
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);

  if (isDark) {
    html.classList.add('theme-dark');
    sunIcon?.classList.add('hidden');
    moonIcon?.classList.remove('hidden');
  }

  themeToggle?.addEventListener('click', () => {
    const isDarkNow = html.classList.contains('theme-dark');
    
    // Use View Transitions API if supported
    if ('startViewTransition' in document) {
      (document as any).startViewTransition(() => {
        toggleTheme(isDarkNow);
      });
    } else {
      toggleTheme(isDarkNow);
    }
  });

  function toggleTheme(isDark: boolean) {
    if (isDark) {
      html.classList.remove('theme-dark');
      localStorage.setItem('theme', 'light');
      sunIcon?.classList.remove('hidden');
      moonIcon?.classList.add('hidden');
    } else {
      html.classList.add('theme-dark');
      localStorage.setItem('theme', 'dark');
      sunIcon?.classList.add('hidden');
      moonIcon?.classList.remove('hidden');
    }
  }
</script>
