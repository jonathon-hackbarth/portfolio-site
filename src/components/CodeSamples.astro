---
import type { ProjectData } from "../utils/projectUtils";
import { getProjectsData } from "../utils/projectUtils";

const GITHUB_USERNAME = "jonathon-hackbarth";

let projects: ProjectData[] = [];
let error: string | null = null;

try {
  const token = import.meta.env.GH_DEV_TOKEN;
  const repoRes = await fetch(
    `https://api.github.com/users/${GITHUB_USERNAME}/repos?sort=updated&direction=desc`,
    {
      headers: {
        ...(token && { Authorization: `Bearer ${token}` }),
        Accept: "application/vnd.github.v3+json",
      },
    }
  );
  if (!repoRes.ok) {
    throw new Error(`GitHub API responded with ${repoRes.status}`);
  }
  const repos = await repoRes.json();
  projects = await getProjectsData(repos, token);
} catch (err) {
  error = err instanceof Error ? err.message : "Failed to load projects";
}
---

<section id="code-samples" class="py-[var(--spacing-section)]">
  <div class="max-w-[var(--container-max)] mx-auto px-[var(--spacing-md)]">
    <h2 class="font-bold text-[var(--text-primary)] tracking-tight mb-12" style="font-size: var(--font-size-h2); margin: 0 0 var(--spacing-xl) 0;">Code Samples</h2>

    {error && (
      <div class="text-center text-red-500 py-12">
        Error: {error}
      </div>
    )}

    {!error && projects.length === 0 && (
      <div class="text-center text-[var(--text-secondary)] py-12">
        No projects found.
      </div>
    )}

    {!error && projects.length > 0 && (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {projects.map((project, index) => (
          <article 
            class="card animate-fade-up" 
            style={`animation-delay: ${index * 0.1}s`}
          >
            <div class="flex flex-col h-full gap-4">
              <h3 class="text-xl font-semibold text-[var(--text-primary)] tracking-tight">
                {project.name}
              </h3>
              
              <p class="text-sm text-[var(--text-secondary)] flex-grow line-clamp-2 leading-relaxed">
                {project.description || "No description available."}
              </p>

              {project.languages && project.languages.length > 0 && (
                <div class="flex flex-wrap gap-4">
                  {project.languages.slice(0, 3).map((lang) => (
                    <span class="text-xs py-1 bg-[var(--bg-elevated)] text-[var(--text-secondary)] rounded-lg font-medium">
                      {lang.name}
                    </span>
                  ))}
                </div>
              )}

              <div class="flex gap-3 mt-auto">
                {project.homepage && (
                  <a
                    href={project.homepage}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-center text-sm font-semibold bg-[var(--accent-code)] text-white rounded-xl hover:bg-[var(--accent-code-hover)] transition-all shadow-sm hover:shadow-md" style="padding: 10px 20px;"
                    style="padding: 8px 20px;"
                  >
                    View Site
                  </a>
                )}
                <a
                  href={project.html_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class={`text-center text-sm font-semibold bg-[var(--bg-card)] text-[var(--text-primary)] rounded-xl hover:bg-[var(--bg-subtle)] transition-all border border-[var(--border-card)] hover:border-[var(--accent-code)] ${project.homepage ? '' : 'flex-1'}`}
                  style="padding: 8px 20px;"
                >
                  GitHub
                </a>
              </div>

              {project.pushed_at && (
                <p class="text-xs text-[var(--text-secondary)] text-right font-medium">
                  Updated {new Date(project.pushed_at).toLocaleDateString("en-US", { month: "short", year: "numeric" })}
                </p>
              )}
            </div>
          </article>
        ))}
      </div>
    )}
  </div>
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

